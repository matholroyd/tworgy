<script type='text/javascript'>

var geocoder = new google.maps.Geocoder();
var map;
var marker;
var marker_tworgy_id;
var dialogSetMarker;

function setupMap() {
  var latlng = new google.maps.LatLng(-34.397, 150.644);
  if (google.loader.ClientLocation) {
    latlng = new google.maps.LatLng(google.loader.ClientLocation.latitude, google.loader.ClientLocation.longitude);
  }

  var myOptions = {
    zoom: 5,
    center: latlng,
    mapTypeId: google.maps.MapTypeId.ROADMAP
  };
  map = new google.maps.Map($("#map_canvas:first")[0], myOptions);
}

function findAddress() {
  geocoder.geocode( { 'address': $('#inputAddress').val()}, function(results, status) {
    if (status == google.maps.GeocoderStatus.OK) {
      map.fitBounds(results[0].geometry.bounds);
    } else {
      alert("Geocode was not successful for the following reason: " + status);
    }
  });
}

function setDraggableMarker(tworgy_id) {
  addMarker(tworgy_id, map.getCenter());
}

function addMarker(tworgy_id, pos) {
  if(marker) {
    clearMarker();
  }

  marker_tworgy_id = tworgy_id;
  marker = new google.maps.Marker({
    position: pos,
    map: map, 
    title: 'Drag marker to where the Tworgy is happening',
    draggable:true
  });

  // Add dragging event listeners.
   google.maps.event.addListener(marker, 'dragstart', function() {
     updateMarkerAddress('Dragging...');
   });

   google.maps.event.addListener(marker, 'drag', function() {
     updateMarkerStatus('Dragging...');
     updateMarkerPosition(marker.getPosition());
   });
   
   google.maps.event.addListener(marker, 'dragend', function() {
     updateMarkerStatus('Drag ended');
     updateTworgy(tworgy_id, {
       'tworgy[latitude]': marker.getPosition().lat(), 
       'tworgy[longitude]': marker.getPosition().lng()}
     );
     geocodePosition(marker.getPosition());
   });
}

function clearMarker() {
  if(marker) {
    marker.setMap(null);
  }
}

function geocodePosition(pos) {
  geocoder.geocode({latLng: pos}, function(responses) {
    if (responses && responses.length > 0) {
      updateMarkerAddress(responses[0].formatted_address);
    } else {
      updateMarkerAddress('Cannot determine address at this location.');
    }
  });
}

function updateMarkerStatus(str) {
  $('#markerStatus').html(str);
}

function updateMarkerPosition(latLng) {
  $('#markerPosition').html([latLng.lat(), latLng.lng()].join(', '));
}

function updateMarkerAddress(str) {
  $('#markerAddress').html(str);
}

$(document).ready(function() {
  $('a#addList').click(function() {
    $('#fieldsAddList').toggle();
  });

  setupMap();


  $('.addMarker').click(function() {
    $('#finishingOffAddingMarker').show();
    var tworgy_id = this.attributes['ref'].value;
    addMarker(tworgy_id, map.getCenter());
    //dialogSetMarker.dialog('open');
    $('#dialogSetMarker').dialog('open');
  });

  $('#finishedAddingMarker').click(function() {
  
  });

  $('#clearMarker').click(function() {
    clearMarker();
  });

  $('#findAddress').click(function() {
    findAddress();
  });

  var tabs = $("#tabs").tabs({ selected: 0 });

  $('#dialogSetMarker').dialog({
    autoOpen:false,
    modal:true,
    buttons: { 
      "Cancel": function() { $(this).dialog("close"); },
      "Create Tworgy":function() { $(this).dialog("close"); }
    }
  });
  
  $("ul#location_list li span").click(function() {
    $("ul#location_list li").removeClass('active');
    
    var li = $(this).parent();
    var tworgy_id = li.attr('ref');

    li.addClass('active');
    setDraggableMarker(tworgy_id);
  });
  $("ul#location_list li input").click(function() {
    toggleCheckBox(this, true);
  });

  $("ul#location_list li input").each(function() {
     toggleCheckBox(this, false);
  });
});   


function tworgyPath(tworgy_id) {
  return '/tworgies/' + tworgy_id;
}

function updateTworgy(tworgy_id, data) {
  $.put(tworgyPath(tworgy_id), data, null, 'json');
}

function toggleCheckBox(checkbox, update) {
  var enabled = checkbox.checked;
  var li = $(checkbox).parent();
  
  li.toggleClass("enabled", enabled);    
  var tworgy_id = li.attr('ref');
  
  if(update) {
    updateTworgy(tworgy_id, {'tworgy[enabled]': enabled});
  }
}

</script>